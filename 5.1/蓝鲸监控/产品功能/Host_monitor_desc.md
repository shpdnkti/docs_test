## 蓝鲸监控 - 功能介绍

蓝鲸监控目前已覆盖网络层、主机层、组件层、应用层、服务层，主动拨测监控。对于无法开箱即用的监控对象，用户可以通过脚本采集、日志采集以及组件二次开发实现自定义监控，通过仪表盘实现自定义可视化视图呈现。

基于 IPaaS 的产品设计（关联配置平台、作业执行、数据平台等），天然打破“竖井式”产品设计理念，依托于蓝鲸体系中的故障自愈实现告警的无人值守。

以下文档会对上述功能进行详细说明，产品的使用请参考[快速入门](../快速入门/Getting_started.md)。

## 主机监控 功能概述 {#host_monitor}

蓝鲸监控支持以主机为单元的基础性能指标查看、告警策略配置等功能。指标支持CPU、内存、磁盘、网络、进程、系统、事件（ Corefile产生 、主机重启等）等7类共30~40项指标，满足用户对主机层的精准监控。

![主机监控](../media/host_monitor.gif)
图1. 主机监控视图

### 主机基础性能采集方式 {#host_monitor_collection}

[部署蓝鲸 Gse_Agent ](http://docs.bk.tencent.com/product_white_paper/bk_nodeman/installation/agent.html)后，默认会拉起 `basereport` 进程自动上报主机性能指标（CPU、内存、网络、磁盘、TCP连接数等指标），关于采集器详情可参考附录文档[采集器概述](../二次开发/plugins.md)

![](../media/15367250851552.jpg)
图2. 基础性能采集器工作状态示意图

主机性能指标默认采集周期为1分钟。

### 主机基础性能指标定义 {#host_monitor_index}

| 指标               | 类型 | 单位 | 含义                                                | 采集方法(Linux)                                                                                                                                                   | 采集方法(Windows)                                                                                                                                                                                                    |
| ------------------ | ---- | ---- | --------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 5分钟平均负载      | CPU  | %    | 五分钟内同时处于就绪状态的平均进程数                | awk ‘{print $2}’ /proc/loadavg                                                                                                                                    | N/A                                                                                                                                                                                                                  |
| cpu总使用率        | CPU  | %    | 当前消耗的总CPU百分比                               | delta(busy) / delta(total) * 100 busy = user + sys + nice + iowait + irq + softirq + steal + guest + guestnice + stolen total = busy + idle                       | for /f “tokens=1,2,* delims==” %i in (‘wmic path Win32_PerfFormattedData_Counters_ProcessorInformation where "Name=’_Total’" get PercentIdleTime/value &#124; findstr PercentIdleTime’) do (set /a 100-%j)           |
| cpu单核使用率      | CPU  | %    | 当前单个CPU消耗的百分比                             | delta(busy) / delta(total) * 100 busy = user + sys + nice + iowait + irq + softirq + steal + guest + guestnice + stolen total = busy + idle                       | for /f “tokens=1,2,* delims==” %i in (‘wmic path Win32_PerfFormattedData_Counters_ProcessorInformation where “not name like ‘%Total%’” get PercentIdleTime/value &#124; findstr PercentIdleTime’) do (set /a 100-%j) |
| 接收字节流量       | 网络 | KB/s | 网卡每秒接收的比特数，即网卡的上行带宽              | 读取/proc/net/dev文件 第1项SpeedRecv = delta(new.BytesRecv, old.BytesRecv) / interval                                                                             | wmic path Win32_PerfRawData_Tcpip_NetworkInterface get BytesReceivedPersec/value &#124; findstr BytesReceivedPersec                                                                                                  |
| 发送字节流量       | 网络 | KB/s | 网卡每秒发送的比特数，即网卡的下行带宽              | 读取/proc/net/dev文件第9项SpeedSent = delta(new.BytesSent, old.BytesSent) / interval                                                                              | wmic path Win32_PerfRawData_Tcpip_NetworkInterface get BytesSentPersec/value &#124; findstr BytesSentPersec                                                                                                          |
| 发送包速率         | 网络 | 个/s | 网卡每秒接收的数据包数                              | 读取/proc/net/dev文件 第10项 SpeedPacketsSent = (counterDiff(once.Stat[i].PacketsSent, val.PacketsSent, NetCoutnerMaxSize)) / interval                            | wmic path Win32_PerfRawData_Tcpip_NetworkInterface get PacketsSentPersec/value &#124; findstr PacketsSentPersec                                                                                                      |
| 接收包速率         | 网络 | 个/s | 网卡每秒发送的数据包数                              | 读取/proc/net/dev文件 第2项 SpeedPacketsRecv = delta(new.PacketsRecv, old.PacketsRecv) / interval                                                                 | wmic path Win32_PerfRawData_Tcpip_NetworkInterface get PacketsReceivedPersec/value &#124; findstr PacketsReceivedPersec                                                                                              |
| established连接数  | 网络 | 个   | 当前服务器下TCP链接处于ESTABLISHED状态的连接数      | 系统netlink实现 验证方法netstat -pant&#124;grep ESTABLISHED                                                                                                       | netstat -ano -p tcp &#124; more +4 &#124; find " ESTABLISHED "                                                                                                                                                       |
| time_wait连接数    | 网络 | 个   | 当前服务器下TCP链接处于TIME_WAIT状态的连接数        | 系统netlink实现 验证方法netstat -pant&#124;grep TIME_WAIT                                                                                                         | netstat -ano -p tcp &#124; more +4 &#124; find " TIME_WAIT "                                                                                                                                                         |
| listen连接数       | 网络 | 个   | 当前服务器下TCP链接处于LISTEN状态的连接数           | 系统netlink实现 验证方法netstat -pant&#124;grep LISTEN                                                                                                            | netstat -ano -p tcp &#124; more +4 &#124; find " LISTENING "                                                                                                                                                         |
| last_ack连接数     | 网络 | 个   | 当前服务器下TCP链接处于LAST_ACK状态的连接数         | 系统netlink实现 验证方法netstat -pant&#124;grep LAST_ACK                                                                                                          | netstat -ano -p tcp &#124; more +4 &#124; find " LAST_ACK "                                                                                                                                                          |
| syn_recv连接数     | 网络 | 个   | 当前服务器下TCP链接处于SYN_RECV状态的连接数         | 系统netlink实现 验证方法netstat -pant&#124;grep SYNC_RECV                                                                                                         | netstat -ano -p tcp &#124; more +4 &#124; find " SYN_RECV "                                                                                                                                                          |
| syn_sent连接数     | 网络 | 个   | 当前服务器下TCP链接处于SYN_SENT状态的连接数         | 系统netlink实现 验证方法netstat -pant&#124;grep SYNC_SENT                                                                                                         | netstat -ano -p tcp &#124; more +4 &#124; find " SYN_SENT "                                                                                                                                                          |
| fin_wait1连接数    | 网络 | 个   | 当前服务器下TCP链接处于FIN_WAIT1状态的连接数        | 系统netlink实现 验证方法netstat -pant&#124;grep FIN_WAIT1                                                                                                         | netstat -ano -p tcp &#124; more +4 &#124; find " FIN_WAIT_1 "                                                                                                                                                        |
| fin_wait2连接数    | 网络 | 个   | 当前服务器下TCP链接处于FIN_WAIT2状态的连接数        | 系统netlink实现 验证方法netstat -pant&#124;grep FIN_WAIT2                                                                                                         | netstat -ano -p tcp &#124; more +4 &#124; find " FIN_WAIT_2 "                                                                                                                                                        |
| closing连接数      | 网络 | 个   | 当前服务器下TCP链接处于CLOSING状态的连接数          | 系统netlink实现 验证方法netstat -pant&#124;grep CLOSING                                                                                                           | netstat -ano -p tcp &#124; more +4 &#124; find " CLOSING "                                                                                                                                                           |
| closed状态连接数   | 网络 | 个   | 当前服务器下TCP链接处于CLOSED状态的连接数           | 系统netlink实现 验证方法netstat -pant&#124;grep CLOSED                                                                                                            | netstat -ano -p tcp &#124; more +4 &#124; find " CLOSE "                                                                                                                                                             |
| UDP接收包量        | 网络 | 个   | UDP包接受数                                         | 读取 /proc/net/snmp 文件 InDatagrams项 cat /proc/net/snmp&#124;grep Udp:&#124;grep -v ‘InDatagrams’&#124;awk ‘{print $2}’                                         | wmic path Win32_PerfFormattedData_Tcpip_UDPv4 get DatagramsReceivedPersec/value                                                                                                                                      |
| UDP发送包量        | 网络 | 个   | UDP包发送数                                         | 读取 /proc/net/snmp 文件 OutDatagrams项 cat /proc/net/snmp&#124;grep Udp:&#124;grep -v ‘InDatagrams’&#124;awk ‘{print $5}’                                        | 读取/proc/net/dev文件 第2项 SpeedPacketsRecv = delta(new.PacketsRecv, old.PacketsRecv) / interval                                                                                                                    |
| 可用物理内存       | 内存 | MB   | 可用内存容量                                        | 读取 /proc/meminfo 文件 MemTotal字段*1024 cat /proc/meminfo &#124;grep ‘MemTotal’&#124;awk -F ‘:’ ‘{print $2}’&#124;awk ‘{print $1}’&#124;awk ‘{print $1 * 1024}’ | for /f “tokens=1,2,* delims==” %i in (‘wmic OS get FreePhysicalMemory/value&#124; findstr FreePhysicalMemory’) do (set /a %j/1024)                                                                                   |
| 交换分区已用量     | 内存 | MB   | 交换分区使用容量                                    | 读取 /proc/meminfo 文件 golang系统调用syscall.Sysinfo sysinfo.Totalswap - sysinfo.Freeswap 验证方法free -m                                                        | wmic os get TotalSwapSpaceSize/value                                                                                                                                                                                 |
| 物理内存使用率     | 内存 | %    | 内存使用百分比                                      | 读取 /proc/meminfo 文件[MemTotal-MemFree]/MemTotal*100.0                                                                                                          | wmic os get FreePhysicalMemory,TotalVisibleMemorySize/value                                                                                                                                                          |
| 物理内存使用量     | 内存 | MB   | 已经使用的内存容量                                  | 读取 /proc/meminfo 文件[MemTotal-MemFree]*1024                                                                                                                    | wmic os get FreePhysicalMemory,TotalVisibleMemorySize/value &#124; findstr “FreePhysicalMemory TotalVisibleMemorySize”                                                                                               |
| 应用内存使用量     | 内存 | MB   | 应用进程使用的内存量                                | 读取 /proc/meminfo 文件 如果有MemAvailable字段（不同系统版本有差异）(MemTotal-MemAvailable)/1024,如果没有该字段，MemAvailable=MemFree+Buffers+Cached              | N/A                                                                                                                                                                                                                  |
| 应用内存使用率     | 内存 | %    | 应用进程内存量占总内存的百分比                      | 读取 /proc/meminfo 文件 (MemTotal-MemAvailable)/（MemTotal*100.0），如果没有MemAvailable字段，则MemAvailable=MemFree+Buffers+Cached                               | N/A                                                                                                                                                                                                                  |
| 磁盘使用率         | 磁盘 | %    | 磁盘已用空间的百分占比                              | golang 系统调用syscall.Statfs 相当于df                                                                                                                            | for /f “tokens=1,2,* delims==” %i in (‘wmic path Win32_PerfFormattedData_PerfDisk_LogicalDisk where “name like ‘%:%’” get PercentFreeSpace/value &#124; findstr PercentFreeSpace’) do (set /a 100-%j)                |
| 读速率             | 磁盘 | 次/s | 磁盘每秒输出次数                                    | 读取 /proc/diskstats 每一行的第四项 float64((new_stat.ReadCount - stat.ReadCount)) / 60 只上报逻辑分区                                                            | wmic path Win32_PerfFormattedData_PerfDisk_LogicalDisk get DiskReadsPersec/value                                                                                                                                     |
| 写速率             | 磁盘 | 次/s | 磁盘每秒写入次数                                    | 读取 /proc/diskstats第8项 float64((new_stat.WriteCount - stat.WriteCount)) / 60 只上报逻辑分区                                                                    | wmic path Win32_PerfFormattedData_PerfDisk_LogicalDisk get DiskWritesPersec/value                                                                                                                                    |
| 磁盘IO使用率       | 磁盘 | %    | 磁盘处于活动时间的百分比                            | 读取 /proc/diskstats 文件读取 /proc/diskstats第13项 （new_stat.IoTime - stat.IoTime）/60.0 / 1000.0                                                               | for /f “tokens=1,2,* delims==” %i in (‘wmic path Win32_PerfFormattedData_PerfDisk_LogicalDisk where "Name=’_Total’" get PercentIdleTime/value &#124; findstr PercentIdleTime’) do (set /a 100-%j)                    |
| 系统进程数         | 进程 | 个   | 系统已启动进程数量                                  | 抓取/proc 目录下所有子目录数量                                                                                                                                    | wmic path win32_process get ProcessId/value                                                                                                                                                                          |
| Agent心跳丢失-GSE  | 事件 | /    | 监测GSE的Agent是否正常                              | N/A                                                                                                                                                               | N/A                                                                                                                                                                                                                  |
| 磁盘只读-GSE       | 事件 | /    | 监测磁盘状态                                        | N/A                                                                                                                                                               | N/A                                                                                                                                                                                                                  |
| 磁盘写满-GSE       | 事件 | /    | 监测磁盘状态                                        | N/A                                                                                                                                                               | N/A                                                                                                                                                                                                                  |
| Corefile产生-GSE   | 事件 | /    | 监测/proc/sys/kernel/core_pattern中目录内文件的变化 | N/A                                                                                                                                                               | N/A                                                                                                                                                                                                                  |
| PING不可达告警-GSE | 事件 | /    | 监测PING不可达事件告警                              | N/A                                                                                                                                                               | N/A                                                                                                                                                                                                                  |
| 进程端口           | 事件 | /    | 进程对应端口                                        | N/A                                                                                                                                                               | wmic path win32_process get */value 和 netstat -ano                                                                                                                                                                  |
| 自定义字符型       | 事件 | /    | N/A                                                 | N/A                                                                                                                                                               | N/A                                                                                                                                                                                                                  |
| 系统启动时间异常   | 事件 | /    | 监测系统启动异常告警                                | N/A                                                                                                                                                               | N/A                                                                                                                                                                                                                  |
