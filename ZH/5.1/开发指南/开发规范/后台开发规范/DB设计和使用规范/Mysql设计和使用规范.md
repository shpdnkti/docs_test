## Mysql 设计和使用规范

### 1. 库表字段设计规范

- 【必须】库/表/字段的字符集必须保持一致
- 【必须】**所有表必须要有主键，主键不能使用更新频繁的列**，以定长类型作为主键或者联合主键的第一字段
- 【必须】不使用 UUID MD5   HASH 这些值作为主键(一般使用连续递增的值作为主键，比如自增ID)  【必须】存在自增列的表，自增列上必须存在一个单独的索引，若在复合索引中，自增列必须置于第一位 
- 【建议】建表时应建立好合适的索引，并考虑未来的需求建立保留索引，避免上线后数据量增大再来创建新索引
- 【建议】建表时可以适当考虑未来功能需求，设计一些保留字段，避免频繁的DB增加字段             【建议】避免使用临时表
- 【建议】表中避免使用外键
- 【必须】**库名、表名、字段名避免使用MySQL** **保留字**(如: BACKUP/CACHE/CODE等)   详细参看官方文档   8.0版本https://dev.mysql.com/doc/refman/8.0/en/keywords.html            
- 【必须】所有字段均定义为 NOT   NULL ，并设置default值   (NULL 字段很难优化查询，NULL字段的索引需要额外空间，NULL字段的复合索引无效) 
- 【建议】避免单表太多字段, 最好不超过 32 个，尤其是版本不断迭代的情况下，如果字段过多，建议适当考虑分表而不是加字段 
- 【建议】加字段尽量在表的末尾增加，避免使用after/before类alter操作
- 【建议】尽可能避免单个blob过大，实在不行请分表
- 【建议】如果使用到text/blob类型，单表避免使用超过8个blob字段；如果blob字段内容较多，程序考虑做压缩   (blob超过8个建议使用row_format=dynamic行格式来存储)            
- 【建议】整型字段, 如果数据量会很大,请使用BIGINT,避免字段溢出(流水ID/道具ID等) 
- 【建议】日期字段建议用DATETIME
- 【建议】强烈建议使用TINYINT来代替ENUM类型
- 【建议】遵循精确原则，用DECIMAL代替FLOAT和DOUBLE存储精确浮点数             
- 【建议】建议使用INT   UNSIGNED存储IPV4            
- 【建议】使用UNSIGNED存储非负整数            
- 【必须】所有表/字段均应使用comment 来描述此表/字段所代表的真正含义             
- 【必须】禁止在数据库中存储明文密码，把密码在应用层做加密后存储(非对称算法最佳)    
- 【必须】数据库中不允许存储视频或者照片等大文件，可以将大对象放到磁盘或者其他对象存储上  

### 2. 索引规范

- 【必须】单表中索引数量不超过5个，过多的索引会影响UPDATE/INSERT/DELETE操作
- 【必须】单个索引中的字段数不超过5个
- 【必须】单表中的索引数禁止超过字段数
- 【必须】重要的SQL必须被索引，核心SQL优先考虑覆盖索引，避免回表 (说明：索引包含所有满足查询需要的数据的索引就是覆盖索引)
- 【必须】禁止重复索引(一个字段上建立多个索引)  例如表含有 `primary key a` `uniq index a` `index a`，则字段a被建了3个重复索引
- 【必须】禁止冗余索引(多个索引的前缀列相同，或在联合索引中包含了主键的索引) 例如表有索引idx1(a,b,c)、idx2(a,b)，则idx2为冗余索引，因为idx1已经包含idx2
- 【必须】`UPDATE/DELETE` 语句的 `WHERE` 条件列；`ORDER BY、GROUP BY、DISTINCT`的字段；多表关联的JOIN字段都应该要有索引
- 【必须】区分度最大的字段放在前面，符合最左前缀的特点建立索引
- 【必须】不在索引列进行数学运算和函数运算，否则无法使用索引/导致全表扫描。例子: `SELECT name FROM class WHERE  ABS(score) > 80;`
- 【必须】不在低基数列上建立索引，例如“性别”、布尔值的列
- 【必须】索引字段的默认值不能为 NULL ，要改为其他的默认值，因NULL值对查询效率影响很大
- 【知会】对字符串使用前缀索引，前缀索引长度不超过8个字符，但在ORDER BY 或 GROUP BY 中使用不到前缀索引。建立前缀索引的语法：`ALTER TABLE table_name ADD KEY(column_name(prefix_length));`
- 【知会】尽量不在BLOB/TEXT等字段上建立索引，且BLOB 和 TEXT 类型的列只能创建前缀索引
- 【知会】合理创建联合索引(避免冗余)，减少维护索引的IO开销
- 【知会】使用不等于 (!=、<>、not in 、not like等) 的时候，MYSQL 无法使用索引
- 【知会】使用 LIKE 操作的时候where条件以%开始 (如‘%abc’)时，MYSQL无法使用索引，使用通配符尽量不要放在开头
- 【知会】多表关联中join条件字段类型不一致的时候无法使用索引

### 3. SQL语句设计规范

- 【必须】MySQL不擅长数学计算，不要把大计算量的SQL放在MySQL中执行。 如：统计/计算类操作避免从DB中直接计算
- 【必须】单次查询的结果集行数不要过多(控制在几百几千行)，如果结果集确实很多，注意控制查询频率(避免对DB机器的流量/IO/CPU等产生压力)
- 【必须】避免使用 `CREATE table AS SELECT * FROM ...`的操作
- 【必须】程序层避免使用  `INSERT INTO … SELECT  *`
- 【必须】不要用 `SELECT  *  FROM`，查询哪几个字段就SELECT几个字段
- 【必须】业务代码中事务及时提交，避免产生没必要的锁等待
- 【必须】SQL中使用到OR的改写为用IN()，且in的值最好不超过1000个
- 【必须】SQL中避免隐式转换，会导致索引失效(这是一个大坑)，如：数值类型禁止加引号；字符串类型必须加引号
- 【必须】充分利用前缀索引，而且要符合最左前缀原则
- 【必须】不使用%前导的查询，如`like “%abc"`，会导致索引失效
- 【必须】不使用负向查询，如NOT IN、NOT LIKE、!=、<>会导致无法使用索引，引起全表扫描，并且会把NULL查出来
- 【必须】UPDATE、DELETE语句必须使用WHERE条件
- 【必须】清理历史数据时，不要一次清理过多，建议使用`DELETE … LIMIT N`分批清理
- 【必须】统计行数使用`COUNT(*)`，避免使用COUNT(app)这样的操作
- 【必须】INSERT语句必须指定字段列表，禁止使用`INSERT INTO TABLE()`
- 【必须】禁止使用`ORDER BY RAND()`
- 【建议】避免使用JOIN联表操作
- 【建议】避免使用触发器、函数、存储过程、event等
- 【建议】如果确认合并的两个结果集中不包含重复的数据，那么请使用UNION ALL 而不是 UNION
- 【建议】减少与数据库交互次数，尽量采用批处理SQL语句
- 【必须】防止SQL注入，程序应对传入的参数进行严格校验，正确过滤字符，而且避免使用动态拼装SQL
