# 会话窗口

会话窗口（Session window）是通过 Session 来对数据进行分组的。和其它窗口相比，会话窗口是没有窗口重叠的，窗口大小也是不固定的。当一个固定的时间周期内不再收到元素，这个窗口就会关闭。会话窗口通过一个间隔时间来配置的。下图展示一个会话窗口，注意每个 key 由于不同的数据分布有不同的 window。
![](../../../../assets/dataflow/stream-processing/session-window.png)

- 过期时间参数说明，只限于会话窗口使用
此参数适用于数据稀疏的场景，当设置过期时间后，数据在特定时间内（间隔时间+过期时间）没有产生新的数据，就会关闭当前会话窗口并输出此窗口的数据。

*注：当间隔时间设置很长，或者数据一直是连续的，没有出现间隔时间的数据真空，会导致窗口长期不关闭，计算资源就会有不足的风险，会导致无数据输出。*

## 数据输出说明

 - 数据时间：事件时间，一般是事件产生的时间。
 - 等待时间：是用于处理数据时间乱序这种情况的。例如，设置等待时间为 60 秒，当数据源数据延迟 60 秒之内到达都可以进入窗口计算，这时候计算结果将延迟 60 秒输出。
 - 窗口输出时间：由于会话窗口的独特性，窗口的输出时间为窗口的结束时间。

## 延迟数据计算

在实际应用中，由于各种各样的原因，数据到达实时计算会产生不同程度的乱序。在默认情况下，当前窗口计算结果输出后，再有此窗口之前的数据到达时（包含此窗口），这些数据会丢弃，不会进行计算。

为了能够让这些数据正常计算，数据平台推出了延迟数据计算功能，将延迟到达的数据重新开启窗口进行计算，然后输出延迟数据的计算结果，由于正常的数据已经输出过计算结果了。<font color="#dd0000">**开启此功能后，相同数据时间、相同维度的数据可能会出现多条**</font>，这就需要在使用结果数据时，再次进行汇总。

举例： 当前实时计算（1_example_table）配置滚动窗口，统计频率为 1 分钟，sql 如下：
```sql
SELECT count(1) as cnt FROM table
```
数据源数据如下：

|    墙上时间           | 数据时间               |
| -----------------    | -------------------- |
| 2020-01-01 09:01:01  |  2020-01-01 09:01:01 |
| 2020-01-01 09:02:02  |  2020-01-01 09:02:02 |
| 2020-01-01 09:02:03  |  2020-01-01 09:02:03 |
| 2020-01-01 09:03:03  |  2020-01-01 09:03:03 |
| 2020-01-01 09:03:04  |  2020-01-01 09:01:11 |
| 2020-01-01 09:03:05  |  2020-01-01 09:03:05 |


- 不开启延迟数据计算功能，输出结果如下：

|    数据时间           | cnt |
| -----------------    | --- |
| 2020-01-01 09:01:00  |  1  |
| 2020-01-01 09:02:00  |  2  |

延迟到达的数据时间为 “2020-01-01 09:01:11”的数据被丢弃了。

- 开启延迟数据计算功能，输出结果如下：

|    数据时间           | cnt |
| -----------------    | --- |
| 2020-01-01 09:01:00  |  1  |
| 2020-01-01 09:02:00  |  2  |
| 2020-01-01 09:01:00  |  1  |

延迟到达的数据单独开窗进行计算并输出结果，这需要在使用结果数据时进行汇总。使用结果数据方式如下：
```sql
SELECT sum(cnt) as cnt FROM table
```

![](../../../../assets/dataflow/stream-processing/allowed-lateness.png)

- 功能说明
1. “计算延迟数据”功能是默认不开启的
2. 上图中“延迟时间”是指允许延迟多久的数据进入窗口计算，不在延迟时间范围内的延迟数据将会被丢弃
3. 上图中“统计频率”是指延迟的数据的统计周期。由于会话窗口的特殊性，会话窗口没有统计频率，每条延迟数据单独计算输出
4. 开启“计算延迟数据”功能后，使用对应表的结果数据时，需要进行汇总
5. 此功能仅对可以进行二次汇总的函数，如 avg 函数不适用于此功能
