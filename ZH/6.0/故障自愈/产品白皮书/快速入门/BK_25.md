# 故障自愈套餐大全

## 组合套餐

组合套餐，顾名思义就是把该业务下的套餐和官方通用套餐组合起来使用。

具体操作: 按照配置的流程顺序执行套餐

使用场景: 当单一的套餐无法满足故障恢复流程时，将套餐串起来用。

## 按时间汇总后通知

具体操作: 根据配置按一定维度收敛后，发送通知给用户

使用场景: 对于一些大量出现的告警，如单机性能告警/流量告警等，可以用此套餐收敛后发送通知。

参数说明:

时间段和告警数必须填一个。

按时间段汇总：从收到第一条告警开始计时，到规定时间后结束。

按告警数汇总：从收到第一条告警开始计数，到规定数量后结束。

少于多少条不通知：选择时间段汇总时，如果到时间后，告警数量少于指定数量，就不发通知。

可以选择是否将告警存档在自愈，推荐不保存，直接在对接的监控系统中查看历史告警，以免告警列表页面被无效告警淹没。

案例:

希望累计出现3条告警通知一次。参数为0，0，3

希望有告警产生就每20分钟汇总通知一次。参数为20，0，0

希望每30分钟内累计出现5条以上告警通知一次。参数为30，5，0

希望30分钟汇总一次，或者累计出现10条告警就马上通知。参数为30，0，10

## 作业平台

调用蓝鲸作业平台，作业平台脚本需要按照一定规范来。

具体操作: 调用作业平台作业

使用场景: 希望在机器上执行脚本的故障恢复操作，如拉起进程等

参数说明:

通过选择框选择作业平台作业;

可以自定义传入作业平台的参数(不填默认传入故障 IP);

可以通过作业平台脚本获取自愈变量来在其他套餐中使用

## 获取故障机备机

根据配置平台的配置属性获取备机。许多故障替换操作都依赖于此套餐。

除了通过这个套餐获取备机外，也可以通过作业平台来获取备机，只要使用作业平台套餐获取变量为 ip_bak 的参数即可。

具体操作:

根据配置，在配置平台指定的 Set 与 AppModule 中，查找指定属性与故障机相同的机器。

将所有符合条件的机器 IP 通过微信让运维审批选择。此后备机 IP 就能通过变量在其他套餐中获取。

使用场景: 在组合套餐中调用故障替换的操作套餐前必须先调用过此套餐

## 通知或审批

具体操作：调用不同的接口发送通知或审批(发送微信失败会改为短信，发送短信失败则发微信，邮件通知接口调用失败将不做处理)

使用场景：

一般用户组合套餐中；

通知，自定义消息发送到微信等平台；

审批，执行服务器故障替换流程时，让运维审批是否执行替换，降低风险

## 暂停等待

具体操作：暂停一定时间

使用场景：重启操作后 Agent 可能还没准备好，可以等待一定时间后再继续后面的流程

## 自定义收敛防御

具体操作: 在指定时间内，出现过指定告警数量的相同 IP，相同告警类型，将会收敛次条告警

使用场景: 想添加某些异常防御条件的时候。大部分需求故障自愈的收敛功能就能满足

## 『快捷』套餐

每个业务默认都会有一批可以选择的套餐，用户几乎不需要对其做任何配置可以直接使用。对于这种套餐，我们用称为『快捷』套餐。
(部分『快捷』套餐只能在组合套餐中选用)

### 『快捷』配置平台拷贝故障机属性到备机(得先调选择备机)

具体操作: 调用配置平台替换接口，
将替换机转移到与故障机相同的模块下(包括属于故障机多个模块的情况)；
拷贝故障机的标准属性到替换机；
拷贝故障机的自定义属性到替换机；
拷贝故障机的进程端口到替换机；

使用场景: 故障机切换后拷贝故障机 CC 信息到备机

### 『快捷』发送审核(微信+短信)

具体操作: 发送微信与短信进行审批，内容为：【故障自愈】即将执行(\${组合套餐中下一个步骤的名称})(\${业务名称}、模块为\${模块}、IP为\${IP})，请审核！

使用场景: 当下一步执行的操作希望人工审批是否要继续执行的时候，在步骤前调用。

### 『快捷』发送通知(微信+邮件)

具体操作: 发送微信和邮件通知，内容为：【故障自愈】执行(\${组合套餐中上一个步骤的名称})\${组合套餐中上一个步骤的执行结果}(\${业务名称}、模块为\${模块}、IP为\${IP})，请关注！

使用场景: 希望执行完某个步骤后，发送成功或者失败后的结果通知。

### 『快捷』发送通知(微信+邮件+短信)

具体操作: 发送微信和邮件外加短信通知，其余同上

### 『快捷』发送通知(电话)

具体操作: 发送电话通知，其余同上

### 『快捷』后续处理对象故障机与备机互换(得先调选择备机)

具体操作: 调用此套餐后，在组合套餐的后续流程中，操作对象将会替换。流程默认都是对故障机进行操作，调用一次后将会默认对备机进行操作。再调用一次，则恢复原状。

使用场景: 例如当获取选定的备机后，想对备机进行初始化操作，那么这时候就要先调用一次此套餐，再调用初始化。初始化后，又想把故障机移动到配置平台的故障机模块，那么就又要调用一次此套餐，然后再调用配置平台移动模块。

### 『快捷』标记组合套餐为基本成功

具体操作: 标注自愈的处理结果为基本成功

使用场景: 自愈的收敛策略为如果处理的套餐相同，那么如果第一个告警处理成功，后面的告警将会被收敛，失败的话则重新处理。
因此，可以在组合套餐中在某些核心步骤处理完后，调用次套餐来标注流程为基本成功，不让一些周边操作影响整个流程，使得一些核心操作被重复执行。例如对于 PING 不可达告警，可以在腾讯云重启成功后标注基本成功，这样即使后续的步骤失败，机器也不会被再次重启。

### 『快捷』确认主机Ping不通(Ping通返回失败)

具体操作: 在故障自愈的机器上 Ping 一次目标机器的内网 IP，Ping 得通返回跳过(走组合套餐失败分支)，Ping 不通返回成功状态

### 『快捷』直接保存无处理

具体操作: 收到告警后直接保存到自愈数据库，不通知也不处理

### 『快捷』不处理，仅触发通知

具体操作: 收到告警后直接保存到自愈数据库，触发接入告警时的通知策略
